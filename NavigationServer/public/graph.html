<!DOCTYPE html>
<html lang="en">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.css" />
<script
        src="https://code.jquery.com/jquery-3.1.1.js"
        integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.js"></script>

<style>
    .result_box {
        height:20em;
        width: 50em;
        border-style: solid;
        padding: 0.5em;
        overflow: hidden;
    }

    #result_table {
        overflow: scroll;
    }

    #query_settings_container {
        display: block;
        width: 15em;
    }

    #standard_query_settings_container {
        display: block;
        width: 20em;
    }

    .preset_query {
        width: inherit;
        height: 3em;
        margin-bottom: 5px;
        background-color: aliceblue;
    }

    .preset_query button {
        float: right;
    }

    .border_box {
        border: 1px solid lightgray;
        height: 25em;
    }

</style>

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h4>Graph</h4>
    <div id="c3_graph" class="result_box"></div>

    <h4> Data </h4>
    <div id="result_table" class="result_box"></div>

    <table>
        <tr>
            <td>
                <div id="query_settings_container" class="border_box">
                    <h4> Query Settings </h4>

                    <p> Start Date </p>
                    <input type="datetime-local" id="start_date">

                    <p> End Date </p>
                    <input type="datetime-local" id="end_date">

                    <p> Observation Type </p>
                    <select id="observation_type">
                        <option value="hotspot">Hotspot</option>
                        <option value="bluetooth">Bluetooth</option>
                        <option value="crowd">Crowd</option>
                        <option value="accelerometer">Accelerometer</option>
                        <option value="audio">Audio</option>
                    </select>

                    <p></p>
                    <button onclick="getDataButtonClick()"> Get Data </button>
                </div>
            </td>
            <td>
                <div id="standard_query_settings_container" class="border_box">
                    <h4> Standard Query Settings </h4>

                    <div class="preset_query">
                        <span> 13:05 - 13:10 quiet cs atrium </span>
                        <br>
                        <span> 3 people </span>
                        <button onclick="preSet('2017-02-24T13:05','2017-02-24T13:10')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:16 - 13:22 busy a32 </span>
                        <br>
                        <span> 50 people </span>
                        <button onclick="preSet('2017-02-24T13:16','2017-02-24T13:22')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:40 - 13:45 walking outside on jubilee </span>
                        <br>
                        <span> no need to classify </span>
                        <button onclick="preSet('2017-02-24T13:40','2017-02-24T13:45')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:53 - 14:50 jubilee sports center </span>
                        <br>
                        <span> 30 people </span>
                        <button onclick="preSet('2017-02-24T13:53','2017-02-24T14:50')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:53 - 14:50 jubilee sports center </span>
                        <br>
                        <span> 30 people </span>
                        <button onclick="preSet('2017-02-24T13:53','2017-02-24T14:50')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> Last 30 minutes </span>
                        <br>
                        <span> unknown </span>
                        <button onclick="periodSet('last30min')"> Set </button>
                    </div>

                </div>
            </td>
        </tr>
    </table>


</body>
</html>

<script>

    var chart;
    newChart();

    function getDataButtonClick() {
        var start_date = $('#start_date').val();
        var end_date = $('#end_date').val();
        var observation_type = $('#observation_type').val();

        if(!start_date || !end_date || !observation_type) {
            alert("You have not completed all of the required values");
            return;
        }

        newChart();

        requestDataWithTime(start_date, end_date, observation_type);

    }

    function preSet(start_date, end_date) {
        $('#start_date').val(start_date);
        $('#end_date').val(end_date);

        newChart();

        requestDataWithTime(start_date, end_date, 'hotspot');
        requestDataWithTime(start_date, end_date, 'bluetooth');
        requestDataWithTime(start_date, end_date, 'crowd');
        requestDataWithTime(start_date, end_date, 'accelerometer');
        requestDataWithTime(start_date, end_date, 'audio');

    }

    function periodSet(period) {
        newChart();

        requestDataWithPeriod(period, 'hotspot');
        requestDataWithPeriod(period, 'bluetooth');
        requestDataWithPeriod(period, 'crowd');
        requestDataWithPeriod(period, 'accelerometer');
        requestDataWithPeriod(period, 'audio');
    }

    function newChart() {
        if(chart) {
            try {
                chart.destroy();
            } catch(ex) {
                console.log("Exception destroying chart caught: " + ex);
            }
        }

        chart = c3.generate({
            bindto: '#c3_graph',
            padding: {
                top: 0,
                right: 20,
                bottom: 0,
                left: 20,
            },
            data: {
                columns: []
            },
            axis: {
                x: {
                    type: 'timeseries',
                    tick: {
                        format: '%Y-%m-%d %H:%M'
                    }
                }
            }
        });
    }

    const server_url = "http://54.154.109.216";

    function requestDataWithTime(start_date, end_date, observation_type) {

        var get_url = server_url;

        get_url += "/observations/";
        get_url += observation_type;
        get_url += "/";
        get_url += start_date;
        get_url += "/";
        get_url += end_date;
        get_url += "?apitoken=koH6a1UC71rTDM1LKppXeKYJ54cjc8nIfuJAKPly1GDYpjMMLLCuK5LBp3fXAEkCcID1jCh5pCQp9D8DmCWhJHQlLcUcy4gD68Qy";

        $.ajax({
            url: get_url,
            method: "GET",
            cache: false,
            success: ajaxSuccessCallback
        });
    }

    function requestDataWithPeriod(period, observation_type) {
        var get_url = server_url;

        get_url += "/observations/";
        get_url += observation_type;
        get_url += "/";
        get_url += period;
        get_url += "?apitoken=koH6a1UC71rTDM1LKppXeKYJ54cjc8nIfuJAKPly1GDYpjMMLLCuK5LBp3fXAEkCcID1jCh5pCQp9D8DmCWhJHQlLcUcy4gD68Qy";

        $.ajax({
            url: get_url,
            method: "GET",
            cache: false,
            success: ajaxSuccessCallback
        });
    }

    function ajaxSuccessCallback(json_response, status){

        if(!json_response.tablename) {
            $('#result_table').html("Response could not be parsed: " + json_response);
            return;
        }

        $('#result_table').prepend(json_response.tablename + " (" + Object.keys(json_response.my_observations).length + " entries)<br>");

        graphData(json_response);
    }

    function graphData(json_response) {
        const my_observations = json_response.my_observations;
        var yAxis = [];
        var xAxis = [];
        var observation_date, xs;

        switch(json_response.tablename) {
            case "hotspot_observations":

                yAxis = ["hotspot_id"];
                xAxis = ["observation_date"];

                for(arrindex in my_observations) {
                    var hotspot_id = my_observations[arrindex].idHotspot;
                    yAxis.push(hotspot_id);

                    observation_date = my_observations[arrindex].observation_date;
                    xAxis.push(new Date(observation_date));

                    console.log("item " + arrindex + " hotspot_id " + hotspot_id + " observation_date " + observation_date);
                }

                xs = {
                    'hotspot_id':'observation_date'
                };

                break;
            case "bluetooth_observations":

                yAxis = ['bluetooth_count'];
                xAxis = ['observation_date'];

                for(arrindex in my_observations) {
                    var bluetooth_count = my_observations[arrindex].bluetooth_count;
                    yAxis.push(bluetooth_count);

                    observation_date = my_observations[arrindex].observation_date;
                    xAxis.push(new Date(observation_date));

                    console.log("item " + arrindex + " bluetooth_count " + bluetooth_count + " observation_date " + observation_date);
                }

                xs = {
                    'bluetooth_count':'observation_date'
                };

                break;
            case "crowd_observations":
                yAxis = ['crowd_sourced'];
                xAxis = ['observation_date'];

                for(arrindex in my_observations) {
                    var crowd_sourced = my_observations[arrindex].occupancy_estimate;
                    yAxis.push(crowd_sourced);

                    observation_date = my_observations[arrindex].observation_date;
                    xAxis.push(new Date(observation_date));

                    console.log("item " + arrindex + " crowd_sourced " + crowd_sourced + " observation_date " + observation_date);
                }

                xs = {
                    'crowd_sourced':'observation_date'
                };

                break;
            case "accelerometer_observations":
                yAxis = ['acceleration'];
                xAxis = ['observation_date'];

                for(arrindex in my_observations) {
                    const acceleration_timeline = JSON.parse(my_observations[arrindex].acceleration_timeline);
                    observation_date = new Date(my_observations[arrindex].observation_date);
                    var average = 0;
                    var count = 0;

                    for(arrindex2 in acceleration_timeline) {
                        const sample = acceleration_timeline[arrindex2];
                        average += sample[0] + sample[1] + sample[2];
                        count++;
                    }

                    yAxis.push(average / count);
                    xAxis.push(observation_date);

                }

                xs = {
                    'acceleration':'observation_date'
                };

                break;
            case "audio_observations":
                yAxis = ['sound_intensity'];
                xAxis = ['observation_date'];
                //xAxis = ['bin']

                for(arrindex in my_observations) {
                    const audio_histograms = JSON.parse(my_observations[arrindex].audio_histogram);
                    observation_date = new Date(my_observations[arrindex].observation_date);

                    for(arrindex2 in audio_histograms) {
                        const audio_histogram = audio_histograms[arrindex2];
                        var average = 0;
                        var count = 0;

                        for(arrindex3 in audio_histogram) {
                            average += audio_histogram[arrindex3];
                            count++;
                        }

                        yAxis.push(average / count );
                        xAxis.push(observation_date);

                    }

                }

                xs = {
                    'sound_intensity':'observation_date'
                    //'sound_intensity':'bin'
                };

                break;
            default:
                $('#result_table').html("tablename " + json_response.tablename + " not supported");
                break;
        }

        chart.load ({
            bindto: "#c3_graph",
            xs: xs,
            columns: [yAxis, xAxis]
        });

    }


</script>