<!DOCTYPE html>
<html lang="en">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.css" />
<script
        src="https://code.jquery.com/jquery-3.1.1.js"
        integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.js"></script>

<style>
    .result_box {
        height:20em;
        width: 50em;
        border-style: solid;
        padding: 0.5em;
    }

    #result_table {
        overflow: scroll;
    }

    #query_settings_container {
        display: block;
        width: 15em;
        height: 20em;
    }

    #standard_query_settings_container {
        display: block;
        width: 20em;
        height: 20em;
    }

    .preset_query {
        width: inherit;
        height: 3em;
        margin-bottom: 5px;
        border: 1px solid lightgray;
    }

    .preset_query button {
        float: right;
    }

    .border_box {
        border: 1px solid lightgray;
    }

</style>

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h4>Graph</h4>
    <div id="c3_graph" class="result_box"></div>

    <h4> Data </h4>
    <div id="result_table" class="result_box"></div>

    <table>
        <tr>
            <td>
                <div id="query_settings_container" class="border_box">
                    <h4> Query Settings </h4>

                    <p> Start Date </p>
                    <input type="datetime-local" id="start_date">

                    <p> End Date </p>
                    <input type="datetime-local" id="end_date">

                    <p> Observation Type </p>
                    <select id="observation_type">
                        <option value="hotspot">Hotspot</option>
                        <option value="bluetooth">Bluetooth</option>
                        <option value="crowd">Crowd</option>
                        <option value="accelerometer">Accelerometer</option>
                        <option value="audio">Audio</option>
                    </select>

                    <p></p>
                    <button onclick="getData()"> Get Data </button>
                </div>
            </td>
            <td>
                <div id="standard_query_settings_container" class="border_box">
                    <h4> Standard Query Settings </h4>

                    <div class="preset_query">
                        <span> 13:05 - 13:10 quiet cs atrium </span>
                        <br>
                        <span> 3 people </span>
                        <button onclick="preSet('2017-02-24T13:05','2017-02-24T13:10')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:16 - 13:22 busy a32 </span>
                        <br>
                        <span> 50 people </span>
                        <button onclick="preSet('2017-02-24T13:16','2017-02-24T13:22')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:40 - 13:45 walking outside on jubilee </span>
                        <br>
                        <span> no need to classify </span>
                        <button onclick="preSet('2017-02-24T13:40','2017-02-24T13:45')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:53 - 14:50 jubilee sports center </span>
                        <br>
                        <span> 30 people </span>
                        <button onclick="preSet('2017-02-24T13:53','2017-02-24T14:50')"> Set </button>
                    </div>

                </div>
            </td>
        </tr>
    </table>


</body>
</html>

<script>

    var chart = c3.generate({
        bindto: '#c3_graph',
        data: {
            columns: []
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%dT%H:%M:%S.%LZ'
                }
            }
        }
    });

    function getData() {
        var start_date = $('#start_date').val();
        var end_date = $('#end_date').val();
        var observation_type = $('#observation_type').val();

        if(!start_date || !end_date || !observation_type) {
            alert("You have not completed all of the required values");
            //alert("start_date: " + start_date + "\n end_date: " + end_date + "\n observation_type: " + observation_type);
        }

        var get_url = "http://54.154.109.216/observations/";

        get_url += observation_type;
        get_url += "/";
        get_url += start_date;
        get_url += "/";
        get_url += end_date;
        get_url += "?apitoken=koH6a1UC71rTDM1LKppXeKYJ54cjc8nIfuJAKPly1GDYpjMMLLCuK5LBp3fXAEkCcID1jCh5pCQp9D8DmCWhJHQlLcUcy4gD68Qy";

        $.ajax({
            url: get_url,
            method: "GET",
            cache: false,
            success: function(data, status){
                var json_response = data;

                if(!json_response.tablename) {
                    $('#result_table').html("Response could not be parsed: " + json_response);
                    return;
                }

                $('#result_table').html(JSON.stringify(json_response));

                graphData(json_response);
            }
        });

    }

    function graphData(json_response) {
        switch(json_response.tablename) {
            case "hotspot_observations":
                break;
            case "bluetooth_observations":
                var my_observations = json_response.my_observations;

                var yAxis = ['bluetooth_count'];
                var xAxis = ['observation_date'];

                for(arrindex in my_observations) {
                    var bluetooth_count = my_observations[arrindex].bluetooth_count;
                    yAxis.push(bluetooth_count);

                    var observation_date = my_observations[arrindex].observation_date;
                    xAxis.push(new Date(observation_date));

                    console.log("item " + arrindex + " bluetooth_count " + bluetooth_count + " observation_date " + observation_date);
                }

                chart.load ({
                    bindto: "#c3_graph",
                    xs: {
                        'bluetooth_count':'observation_date'
                    },
                    columns: [
                        yAxis,
                        xAxis
                    ]
                });

                break;
            case "crowd_observations":
                break;
            case "accelerometer_observations":
                break;
            case "audio_observations":
                break;
            default:
                $('#result_table').html("tablename " + json_response.tablename + " not supported");
                break;
        }

    }

    function preSet(start_date, end_date) {
        $('#start_date').val(start_date);
        $('#end_date').val(end_date);
        getData();
    }

</script>