<!DOCTYPE html>
<html lang="en">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.css" />
<script
        src="https://code.jquery.com/jquery-3.1.1.js"
        integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.11/c3.js"></script>

<style>
    .result_box {
        height:20em;
        width: 50em;
        border-style: solid;
        padding: 0.5em;
        overflow: hidden;
    }

    #result_table {
        overflow: scroll;
    }

    #query_settings_container {
        display: block;
        width: 15em;
    }

    #standard_query_settings_container {
        display: block;
        width: 20em;
    }

    .preset_query {
        width: inherit;
        height: 3em;
        margin-bottom: 5px;
        background-color: aliceblue;
    }

    .preset_query button {
        float: right;
    }

    .border_box {
        border: 1px solid lightgray;
        height: 25em;
    }

    #loadingDiv {
        display: none;
        position: absolute;
        left: 24em;
        top: 12em;
    }

    #loadingGif {
        height: 1em;
        width: 1em;
    }

</style>

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <div id="loadingDiv">
        <img id="loadingGif" src="loading.gif" />
        <span>Loading</span>
    </div>

    <h4>Graph</h4>
    <div id="c3_graph" class="result_box"></div>

    <h4> Data </h4>
    <div id="result_table" class="result_box"></div>

    <table>
        <tr>
            <td>
                <div id="query_settings_container" class="border_box">
                    <h4> Query Settings </h4>

                    <p> Start Date </p>
                    <input type="datetime-local" id="start_date">

                    <p> End Date </p>
                    <input type="datetime-local" id="end_date">

                    <p></p>
                    <button onclick="getDataButtonClick()"> Get Data </button>
                </div>
            </td>
            <td>
                <div id="standard_query_settings_container" class="border_box">
                    <h4> Standard Query Settings </h4>

                    <div class="preset_query">
                        <span> 13:05 - 13:10 quiet cs atrium </span>
                        <br>
                        <span> 3 people </span>
                        <button onclick="preSet('2017-02-24T13:05','2017-02-24T13:10')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:16 - 13:22 busy a32 </span>
                        <br>
                        <span> 50 people </span>
                        <button onclick="preSet('2017-02-24T13:16','2017-02-24T13:22')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:40 - 13:45 walking outside on jubilee </span>
                        <br>
                        <span> no need to classify </span>
                        <button onclick="preSet('2017-02-24T13:40','2017-02-24T13:45')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> 13:53 - 14:50 jubilee sports center </span>
                        <br>
                        <span> 30 people </span>
                        <button onclick="preSet('2017-02-24T13:53','2017-02-24T14:50')"> Set </button>
                    </div>


                    <div class="preset_query">
                        <span> 16:05-16:51 lecture, 17:05-17:54 gym </span>
                        <br>
                        <span> 100 people, 50 people </span>
                        <button onclick="preSet('2017-02-27T15:54','2017-02-27T17:54')"> Set </button>
                    </div>

                    <div class="preset_query">
                        <span> Last 30 minutes </span>
                        <br>
                        <span> unknown </span>
                        <button onclick="lastNMinutes(30)"> Set </button>
                    </div>

                </div>
            </td>
        </tr>
    </table>


</body>
</html>

<script>

    var last_data_loading = false;

    var chart;
    newChart();

    function enableLastLoading() {
        if(last_data_loading == true) {
            alert("The last data set has not yet loaded, please wait until it does before requesting another!");
            return true;
        }

        $('#loadingDiv').css('display','inline');
        last_data_loading = true;
        return false;
    }

    function disableLastLoading() {
        $('#loadingDiv').css('display','none');
        last_data_loading = false;
    }

    function getDataButtonClick() {
        if(enableLastLoading()) return;

        var start_date = $('#start_date').val();
        var end_date = $('#end_date').val();

        if(!start_date || !end_date) {
            alert("You have not completed all of the required values");
            return;
        }

        newChart();

        requestDataWithTime(start_date, end_date);
    }

    function preSet(start_date, end_date) {
        if(enableLastLoading()) return;

        $('#start_date').val(start_date);
        $('#end_date').val(end_date);

        newChart();

        requestDataWithTime(start_date, end_date);
    }

    function lastNMinutes(minute_subtract) {
        if(enableLastLoading()) return;

        var start_date = new Date();

        start_date.setMinutes( start_date.getMinutes() - minute_subtract );

        var end_date = new Date();

        $('#start_date').val(start_date.toISOString().slice(0,16)); //cut to just minute precision
        $('#end_date').val(end_date.toISOString().slice(0,16)); //cut to just minute precision

        newChart();

        requestDataWithTime(start_date.toISOString(), end_date.toISOString());
    }

    function setChartTimeRange(start_date, end_date) {
        chart.axis.min({x: start_date});
        chart.axis.max({x: end_date});
    }

    function newChart() {
        if(chart) {
            try {
                chart.destroy();
            } catch(ex) {
                console.log("Exception destroying chart caught: " + ex);
            }
        }

        chart = c3.generate({
            bindto: '#c3_graph',
            padding: {
                top: 0,
                right: 20,
                bottom: 0,
                left: 20,
            },
            data: {
                columns: []
            },
            axis: {
                x: {
                    type: 'timeseries',
                    tick: {
                        format: '%Y-%m-%d %H:%M'
                    }
                }
            }
        });
    }

    function requestDataWithTime(start_date, end_date) {

        var post_url = "/occupancy/get_occupancy_data";

        $.ajax({
            url: post_url,
            method: "POST",
            data: { start_date: start_date, end_date: end_date },
            cache: false,
            success: ajaxSuccessCallback
        });
    }

    function ajaxSuccessCallback(json_response, status){

        if(!json_response.success) {
            $('#result_table').html("Response could not be parsed: " + JSON.stringify(json_response));
            return;
        }

        //$('#result_table').prepend(Object.keys(json_response.results) + "<br>");
        $('#result_table').prepend("Got Data " + " (" + Object.keys(json_response.results).length + " timestamps)<br>");

        graphData(json_response);
    }

    function graphData(json_response) {
        const results = json_response.results;

        const hotspot_index = 'hotspot_id_count';
        const bluetooth_index = 'avg_bluetooth_count';
        const crowd_index = 'avg_crowd_occupancy_estimate';
        const acceleration_index = 'acceleration_average';
        const audio_index = 'audio_average';
        const timestamp = 'timestamp';

        var hotspotAxis = [hotspot_index];
        var hotspotTimeAxis = [timestamp];

        var bluetoothAxis = [bluetooth_index];
        var bluetoothTimeAxis = [timestamp];

        var crowdAxis = [crowd_index];
        var crowdTimeAxis = [timestamp];

        var accelerationAxis = [acceleration_index];
        var accelerationTimeAxis = [timestamp];

        var audioAxis = [audio_index];
        var audioTimeAxis = [timestamp];


        for(dateindex in results) {
            var date_result = results[dateindex];

            if(date_result[hotspot_index]) {
                hotspotAxis.push(date_result[hotspot_index]);
                hotspotTimeAxis.push(new Date(dateindex));
            }

            if(date_result[bluetooth_index]) {
                bluetoothAxis.push(date_result[bluetooth_index]);
                bluetoothTimeAxis.push(new Date(dateindex));
            }

            if(date_result[crowd_index]) {
                crowdAxis.push(date_result[crowd_index]);
                crowdTimeAxis.push(new Date(dateindex));
            }

            if(date_result[acceleration_index]) {
                accelerationAxis.push(date_result[acceleration_index]);
                accelerationTimeAxis.push(new Date(dateindex));
            }

            if(date_result[audio_index]) {
                audioAxis.push(date_result[audio_index]);
                audioTimeAxis.push(new Date(dateindex));
            }

        }

        var xs = {};

        xs[hotspot_index] = timestamp;
        xs[bluetooth_index] = timestamp;
        xs[crowd_index] = timestamp;
        xs[acceleration_index] = timestamp;
        xs[audio_index] = timestamp;

        chart.load ({
            bindto: "#c3_graph",
            xs: xs,
            columns: [  hotspotAxis, hotspotTimeAxis,
                        bluetoothAxis, bluetoothTimeAxis,
                        crowdAxis, crowdTimeAxis,
                        accelerationAxis, accelerationTimeAxis,
                        audioAxis, audioTimeAxis ]
        });

        disableLastLoading();

    }


</script>